
import { GoogleGenAI } from "@google/genai";

export const askBobroAI = async (query: string) => {
  // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç ReferenceError
  let apiKey = '';
  try {
    // –ü—Ä–æ–±—É–µ–º –¥–æ—Å—Ç–∞—Ç—å –∫–ª—é—á –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç –∏–Ω—ä–µ–∫—Ü–∏–∏
    apiKey = (globalThis as any).process?.env?.API_KEY || '';
  } catch (e) {
    console.warn("–ë–æ–±—Ä–æ-–ò–ò: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ ENV –Ω–∞–ø—Ä—è–º—É—é.");
  }
  
  if (!apiKey) {
    return "–ë–æ–±—Ä–æ-–ò–ò: –û—à–∏–±–∫–∞! API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è API_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ Vercel (Settings -> Environment Variables).";
  }

  const ai = new GoogleGenAI({ apiKey });

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: query,
      config: {
        systemInstruction: `–í—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –ë–æ–±—Ä–æ-–ò–ò (Bobro-AI). –í—ã —ç–∫—Å–ø–µ—Ä—Ç –≤ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ –≤—Å–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –ë–æ–±—Ä–æ–±–ª–æ–∫—Å –Ω–∞ Vercel. 
        –ü–æ–º–æ–≥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –ù–ï –¢–û–õ–¨–ö–û –∏–≥—Ä—ã, –Ω–æ –∏ –í–ï–°–¨ —ç—Ç–æ—Ç —Å–∞–π—Ç (–ø–ª–∞—Ç—Ñ–æ—Ä–º—É). 
        –ò–ù–°–¢–†–£–ö–¶–ò–Ø –î–õ–Ø –î–ï–ü–õ–û–Ø –í–°–ï–ô –ü–õ–ê–¢–§–û–†–ú–´:
        1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ Vercel –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –∫–æ–¥–æ–º –ë–æ–±—Ä–æ–±–ª–æ–∫—Å–∞.
        2. –î–æ–±–∞–≤—å—Ç–µ Environment Variable: API_KEY (–∫–ª—é—á Gemini).
        3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ 'npx vercel --prod'.
        –û–±—ä—è—Å–Ω—è–π—Ç–µ –ø—Ä–æ –≤–∞–ª—é—Ç—ã –ë–æ–±—Ä–æ–±—É–∫ –∏ –ë—É–±—Ä. –ë—É–±—Ä (–ø—Ä–µ–º–∏—É–º) –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã –≤—Å–µ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.
        –û—Ç–≤–µ—á–∞–π—Ç–µ –≤ —Å—Ç–∏–ª–µ —ç–ª–∏—Ç–Ω–æ–≥–æ –±–æ–±—Ä–∞-–∏–Ω–∂–µ–Ω–µ—Ä–∞ üêπüíªüß°.`,
        temperature: 0.7,
      },
    });
    return response.text || "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ë–æ–±—Ä–æ-–ò–ò —Å–µ–π—á–∞—Å –∑–∞–Ω—è—Ç –≥—Ä—ã–∑–µ–Ω–∏–µ–º –∫–∞–±–µ–ª—è —Å–µ—Ä–≤–µ—Ä–∞.";
  } catch (error: any) {
    console.error("Gemini API Error:", error);
    if (error?.message?.includes('Requested entity was not found')) {
      return "–û—à–∏–±–∫–∞: API –∫–ª—é—á –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Google AI Studio (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è Veo).";
    }
    return `–û—à–∏–±–∫–∞ –ë–æ–±—Ä–æ-–ò–ò: ${error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
  }
};
